---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

const SHIPP = 5;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
			<div class="w-full">
				<img src="/magitech-transparent.png" alt="Magitech Logo" style="width: 300px; display: block; margin: 0 auto;" class="h-auto" />
			</div>
			<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; max-width: 2000px; margin-left: auto; margin-right: auto; flex-wrap: wrap;">
				<img src="/astrolabe-elements-package.jpg" alt="Astrolabe Elements Package" style="max-height: 450px; width: auto; object-fit: contain;" />
				<img src="/astrolabe-elements-documentation.png" alt="Astrolabe Elements Documentation" style="max-height: 450px; width: auto; object-fit: contain;" />
			</div>
			<div style="text-align: center; margin-top: 2rem;">
				<a 
					id="add-to-cart-btn"
					href="#"
					style="display: inline-block; background-color: #635BFF; color: white; padding: 1rem 2rem; border-radius: 0.5rem; text-decoration: none; font-weight: bold; transition: background-color 0.2s; font-family: 'Atkinson', sans-serif; font-size: 20px;"
				>
					Buy Astrolabe Elements Pendant - $36
				</a>
			</div>
			
			<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 4rem; max-width: 2000px; margin-left: auto; margin-right: auto; flex-wrap: wrap;">
				<img src="/venus-orbit-epicycle-package.jpg" alt="Venus Orbit Epicycle Package" style="max-height: 450px; width: auto; object-fit: contain;" />
				<img src="/venus-orbit-epicycle-documentation1.png" alt="Venus Orbit Epicycle Documentation 1" style="max-height: 450px; width: auto; object-fit: contain;" />
				<img src="/venus-orbit-epicycle-documentation2.png" alt="Venus Orbit Epicycle Documentation 2" style="max-height: 450px; width: auto; object-fit: contain;" />
			</div>
			<div style="text-align: center; margin-top: 2rem;">
				<a 
					id="add-to-cart-btn-venus"
					href="#"
					style="display: inline-block; background-color: #635BFF; color: white; padding: 1rem 2rem; border-radius: 0.5rem; text-decoration: none; font-weight: bold; transition: background-color 0.2s; font-family: 'Atkinson', sans-serif; font-size: 20px;"
				>
					Buy Venus Orbit Epicycle - $36.63
				</a>
			</div>
			
			<div style="max-width: 600px; margin: 4rem auto; padding: 0 1rem; text-align: center;">
				<h2 style="margin-bottom: 1rem;">stay updated on new art</h2>
				<form
					action="https://buttondown.com/api/emails/embed-subscribe/astrolabist"
					method="post"
					target="popupwindow"
					onsubmit="window.open('https://buttondown.com/astrolabist', 'popupwindow')"
					class="embeddable-buttondown-form"
					style="display: flex; flex-direction: column; gap: 1rem; align-items: center;"
				>
					<label for="bd-email" style="font-weight: bold;">Enter your email</label>
					<input 
						type="email" 
						name="email" 
						id="bd-email" 
						style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.25rem; width: 100%; max-width: 300px;"
						required
					/>
					
					<input 
						type="submit" 
						value="Subscribe" 
						style="background-color: #635BFF; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.25rem; cursor: pointer; font-weight: bold;"
					/>
					<p style="font-size: 0.875rem; color: #666;">
						<a href="https://buttondown.com/refer/astrolabist" target="_blank" style="color: #635BFF;">Powered by Buttondown.</a>
					</p>
				</form>
			</div>
			
			<div style="max-width: 800px; margin: 4rem auto; padding: 0 1rem; text-align: center;">
				<h2 style="margin-bottom: 1.5rem;">my lightning talk about the astrolabe</h2>
				<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%;">
					<iframe 
						src="https://www.youtube.com/embed/h0MUKPhJaUQ" 
						style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
						title="Astrolabe Lightning Talk"
						allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
						allowfullscreen
					></iframe>
				</div>
			</div>
		</main>
		<Footer />
		<!-- Cart Modal -->
		<div id="cart-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
			<div style="background:white; padding:2rem; border-radius:8px; width:90%; max-width:450px;">
				<ul id="cart-items" style="list-style:none; padding:0; margin:1rem 0;"></ul>
				<div id="cart-total" style="font-weight:bold; margin-bottom:1rem; text-align: right;">Total: $0</div>
				<div style="margin-bottom:1rem; display:flex; align-items:center;">
					<label for="discount-code" style="margin-right:0.5rem; font-size:0.85rem;">Code:</label>
					<input type="text" id="discount-code" style="width:50%; padding:0.25rem; border:1px solid #ccc; border-radius:4px; font-size:0.85rem;">
				</div>
				<div style="display:flex; justify-content:space-between; margin-top:1rem;">
					<button id="keep-shopping-btn" style="padding:0.5rem 1rem; border:none; background:#ccc; border-radius:4px; cursor:pointer;">Keep Browsing</button>
					<button id="pay-btn" style="padding:0.5rem 1rem; border:none; background:#635BFF; color:white; border-radius:4px; cursor:pointer;">Pay</button>
				</div>
			</div>
		</div>

		<!-- Floating Cart Button -->
		<button id="open-cart-btn" style="display:none; position:fixed; bottom:1rem; right:1rem; width:60px; height:60px; border-radius:50%; background-color:var(--accent); color:white; font-weight:bold; font-size:16px; align-items:center; justify-content:center; cursor:pointer; font-family:'Atkinson', sans-serif; box-shadow:0 2px 6px rgba(var(--gray),25%), 0 8px 24px rgba(var(--gray),33%); display:flex;">
			<span>BUY</span><span id="cart-count" style="position:absolute; top:-4px; right:-4px; background:#4CAF50; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px;">0</span>
		</button>

		<script type="module">
			import { Cart } from '/cart.js';
			const SHIPPING = 6;
			// Mapping of product IDs to display names and prices
			// note that this does not include the shipping cost
			// but I include the shipping cost on the "Buy this" buttons
			const PRODUCTS = {
				price_1RIy7IFP96aIwR2hBxHF2Kq6: { name: 'Astrolabe Elements pendant', price: 30 },
				price_1QfVfMFP96aIwR2haxAysFVG: { name: 'Venus Orbit Epicycle necklace', price: 30.63 },
			};

			function updateCartUI() {
				const count = Cart.getItems().reduce((sum, item) => sum + item.quantity, 0);
				const openBtn = document.getElementById('open-cart-btn');
				const cartCount = document.getElementById('cart-count');
				if (openBtn && cartCount) {
					if (count > 0) {
						openBtn.style.display = 'flex';
						cartCount.textContent = count;
					} else {
						openBtn.style.display = 'none';
					}
				}
			}

			function showModal() {
				const modal = document.getElementById('cart-modal');
				if (modal) {
					modal.style.display = 'flex';
				}
			}

			function hideModal() {
				const modal = document.getElementById('cart-modal');
				if (modal) {
					modal.style.display = 'none';
				}
			}

			function renderCartItems() {
				const items = Cart.getItems();
				const itemsList = document.getElementById('cart-items');
				const totalEl = document.getElementById('cart-total');
				let subtotal = 0;
				if (itemsList) {
					itemsList.innerHTML = '';
					items.forEach(item => {
						const prod = PRODUCTS[item.priceId] || { name: item.priceId, price: 0 };
						const lineTotal = prod.price * item.quantity;
						const li = document.createElement('li');
						li.style.display = 'flex';
						li.style.flexDirection = 'row';
						li.style.alignItems = 'center';
						li.style.marginBottom = '0.5rem';
						li.style.flexWrap = 'wrap';
						li.style.justifyContent = 'flex-start';

						const nameSpan = document.createElement('span');
						nameSpan.textContent = prod.name;
						nameSpan.style.fontFamily = 'monospace';
						nameSpan.style.fontSize = '0.85rem';
						nameSpan.style.whiteSpace = 'nowrap';
						nameSpan.style.width = '250px';

						const spacer = document.createElement('div');
						spacer.style.flex = '1';

						const qtyInput = document.createElement('input');
						qtyInput.type = 'number';
						qtyInput.min = '1';
						qtyInput.max = '10';
						qtyInput.value = item.quantity;
						qtyInput.dataset.priceId = item.priceId;
						qtyInput.style.width = '3em';
						qtyInput.style.margin = '0 0.5rem';
						qtyInput.addEventListener('change', (e) => {
							const newQty = parseInt(e.target.value);
							Cart.updateQuantity(item.priceId, newQty);
							if (Cart.getItems().length === 0) hideModal();
							updateCartUI();
							renderCartItems();
						});

						const totalSpan = document.createElement('span');
						totalSpan.textContent = `$${lineTotal.toFixed(2)}`;
						totalSpan.style.width = '100px';
						totalSpan.style.textAlign = 'right';

						const removeBtn = document.createElement('button');
						removeBtn.textContent = 'Ã—';
						removeBtn.style.background = 'none';
						removeBtn.style.border = 'none';
						removeBtn.style.color = 'red';
						removeBtn.style.cursor = 'pointer';
						removeBtn.dataset.priceId = item.priceId;
						removeBtn.addEventListener('click', () => {
							Cart.removeItem(item.priceId);
							if (Cart.getItems().length === 0) hideModal();
							updateCartUI();
							renderCartItems();
						});

						const rightGroup = document.createElement('div');
						rightGroup.style.display = 'flex';
						rightGroup.style.alignItems = 'center';
						rightGroup.style.flex = '0 0 auto';
						rightGroup.style.marginLeft = 'auto';
						rightGroup.appendChild(qtyInput);
						rightGroup.appendChild(totalSpan);
						rightGroup.appendChild(removeBtn);

						const leftGroup = document.createElement('div');
						leftGroup.style.display = 'flex';
						leftGroup.style.alignItems = 'center';
						leftGroup.style.flex = '0 0 250px';
						leftGroup.appendChild(nameSpan);

						li.appendChild(leftGroup);
						li.appendChild(rightGroup);
						itemsList.appendChild(li);

						subtotal += lineTotal;
					});
					// Charge shipping once per cart
					if (items.length > 0) {
						const liShip = document.createElement('li');
						liShip.style.display = 'flex';
						liShip.style.justifyContent = 'flex-end';
						liShip.style.marginBottom = '0.5rem';
						
						const shippingText = document.createElement('span');
						shippingText.textContent = `Shipping:`;
						
						const shippingPrice = document.createElement('span');
						shippingPrice.textContent = `$${SHIPPING.toFixed(2)}`;
						shippingPrice.style.width = '100px';
						shippingPrice.style.textAlign = 'right';
						
						// Create an empty div with the same width as the remove button
						const spacer = document.createElement('div');
						spacer.style.width = '20px'; // Approximate width of the X button
						
						liShip.appendChild(shippingText);
						liShip.appendChild(shippingPrice);
						liShip.appendChild(spacer);
						itemsList.appendChild(liShip);
					}
				}
				if (totalEl) {
					const total = subtotal + (items.length > 0 ? SHIPPING : 0);
					totalEl.innerHTML = ''; // Clear existing content
					
					const totalText = document.createElement('span');
					totalText.textContent = 'Total:';
					totalText.style.fontWeight = 'bold';
					
					const totalPrice = document.createElement('span');
					totalPrice.textContent = `$${total.toFixed(2)}`;
					totalPrice.style.width = '100px';
					totalPrice.style.textAlign = 'right';
					totalPrice.style.fontWeight = 'bold';
					
					// Create spacer for alignment
					const spacer = document.createElement('div');
					spacer.style.width = '20px';
					
					totalEl.style.display = 'flex';
					totalEl.style.justifyContent = 'flex-end';
					totalEl.appendChild(totalText);
					totalEl.appendChild(totalPrice);
					totalEl.appendChild(spacer);
				}
			}

			function openCart(event) {
				event.preventDefault();
				renderCartItems();
				showModal();
			}

			function handleAddToCart(event) {
				event.preventDefault();
				const priceId = 'price_1RIy7IFP96aIwR2hBxHF2Kq6';
				const currentItems = Cart.getItems();
				const existingItem = currentItems.find(item => item.priceId === priceId);
				
				if (!existingItem || existingItem.quantity < 10) {
					Cart.addItem(priceId);
				}
				
				renderCartItems();
				updateCartUI();
				showModal();
			}

			document.addEventListener('DOMContentLoaded', () => {
				// Hide modal on initial load
				hideModal();
				updateCartUI();
				const addBtn = document.getElementById('add-to-cart-btn');
				addBtn?.addEventListener('click', handleAddToCart);

				const addBtnVenus = document.getElementById('add-to-cart-btn-venus');
				addBtnVenus?.addEventListener('click', (event) => {
					event.preventDefault();
					const priceId = 'price_1QfVfMFP96aIwR2haxAysFVG';
					const currentItems = Cart.getItems();
					const existingItem = currentItems.find(item => item.priceId === priceId);
					
					if (!existingItem || existingItem.quantity < 10) {
						Cart.addItem(priceId);
					}
					
					renderCartItems();
					updateCartUI();
					showModal();
				});

				const openBtn = document.getElementById('open-cart-btn');
				openBtn?.addEventListener('click', openCart);

				const keepBtn = document.getElementById('keep-shopping-btn');
				keepBtn?.addEventListener('click', (e) => {
					e.preventDefault();
					hideModal();
				});

				const payBtn = document.getElementById('pay-btn');
				payBtn?.addEventListener('click', async (e) => {
					e.preventDefault();
					const items = Cart.getItems();
					if (items.length === 0) {
						alert('Your cart is empty');
						return;
					}

					try {
						const response = await fetch('https://shop.astrolab.ist/checkout', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								domain: 'astrolab.ist',
								items: items.map(item => ({
									priceId: item.priceId,
									quantity: item.quantity,
									isPhysicalMail: true,
								})),
								discountCode: document.getElementById('discount-code')?.value || null
							})
						});

						if (!response.ok) {
							throw new Error('Checkout failed');
						}

						const data = await response.json();
						if (!data.redirect) {
							throw new Error('No redirect URL provided');
						}

						// Hide modal before redirecting
						hideModal();
						updateCartUI();
						// Redirect to the Stripe checkout URL
						window.location.href = data.redirect;
					} catch (error) {
						console.error('Checkout error:', error);
						window.location.href = '/order-cancel';
					}
				});

				window.addEventListener('storage', () => {
					updateCartUI();
					renderCartItems();
				});
			});
		</script>
	</body>
</html>
